# üîê Requisi√ß√µes HTTP com Proxy e NTLM

Documenta√ß√£o de uso das fun√ß√µes para requisi√ß√µes HTTP com autentica√ß√£o NTLM e proxy corporativo.

---

## üìã √çndice

1. [Configura√ß√£o](#-configura√ß√£o)
2. [Fun√ß√£o requisicaoComNTLM()](#-fun√ß√£o-requisicaocomntlm)
3. [Fun√ß√£o requisicaoComProxy()](#-fun√ß√£o-requisicaocomproxy)
4. [Exemplos de Uso](#-exemplos-de-uso)
5. [Troubleshooting](#-troubleshooting)

---

## ‚öôÔ∏è Configura√ß√£o

### Vari√°veis de Ambiente (.env)

```env
# Autentica√ß√£o NTLM direta (servidor de destino)
NTLM_USER=DOMINIO\\usuario
NTLM_PASS=senha_segura

# Configura√ß√£o do Proxy Corporativo
PROXY_URL=proxy.exemplo.com:8080
PROXY_USER=DOMINIO\\usuario_proxy
PROXY_PASS=senha_proxy
```

> ‚ö†Ô∏è **Importante**: 
> - Use dupla barra invertida (`\\`) para separar dom√≠nio e usu√°rio no Windows
> - O `PROXY_URL` deve estar no formato `host:porta` (ex: `proxy.empresa.com:8080`)

---

## üéØ Fun√ß√£o requisicaoComNTLM()

### Descri√ß√£o
Realiza requisi√ß√£o HTTP com autentica√ß√£o NTLM **direta no servidor de destino** (sem proxy).

### Assinatura
```php
public static function requisicaoComNTLM(
    string $url,              // URL do endpoint
    string $method = 'GET',   // M√©todo HTTP
    array $data = [],         // Dados (POST/PUT/PATCH)
    ?string $usuario = null,  // Usu√°rio NTLM (opcional)
    ?string $senha = null     // Senha NTLM (opcional)
): array
```

### Retorno
```php
[
    'status' => 200,                    // C√≥digo HTTP
    'body' => '{"success": true}',      // Corpo da resposta (string)
    'headers' => [...],                 // Headers da resposta
    'json' => ['success' => true]       // Resposta parseada (se JSON)
]
```

### Quando Usar
‚úÖ Servidor de destino requer autentica√ß√£o NTLM  
‚úÖ Acesso direto √† internet (sem proxy corporativo)  
‚úÖ APIs internas da empresa com Windows Authentication  

---

## üåê Fun√ß√£o requisicaoComProxy()

### Descri√ß√£o
Realiza requisi√ß√£o HTTP atrav√©s de **proxy corporativo** com autentica√ß√£o NTLM no proxy.

### Assinatura
```php
public static function requisicaoComProxy(
    string $url,                    // URL do endpoint
    string $method = 'GET',         // M√©todo HTTP
    array $data = [],               // Dados (POST/PUT/PATCH)
    ?string $proxyUrl = null,       // URL do proxy (host:port)
    ?string $proxyUsuario = null,   // Usu√°rio do proxy
    ?string $proxySenha = null      // Senha do proxy
): array
```

### Retorno
```php
[
    'status' => 200,                    // C√≥digo HTTP
    'body' => '{"data": [...]}',        // Corpo da resposta
    'headers' => [...],                 // Headers da resposta
    'json' => ['data' => [...]]         // Resposta parseada (se JSON)
]
```

### Quando Usar
‚úÖ Rede corporativa com proxy obrigat√≥rio  
‚úÖ Proxy requer autentica√ß√£o NTLM  
‚úÖ Acesso a APIs externas atrav√©s do proxy  
‚úÖ Servidor de destino pode ou n√£o ter NTLM  

---

## üöÄ Exemplos de Uso

### 1. NTLM Direto - GET Simples

```php
use App\Services\Operacao;

// Usa credenciais do .env (NTLM_USER e NTLM_PASS)
$resultado = Operacao::requisicaoComNTLM(
    url: 'https://api.interna.empresa.com/usuarios'
);

if ($resultado['status'] === 200) {
    $usuarios = $resultado['json'];
    foreach ($usuarios as $usuario) {
        echo $usuario['nome'] . "\n";
    }
}
```

### 2. NTLM Direto - POST com Dados

```php
$novoProduto = [
    'nome' => 'Notebook Dell',
    'preco' => 3500.00,
    'categoria' => 'Eletr√¥nicos'
];

$resultado = Operacao::requisicaoComNTLM(
    url: 'https://api.interna.empresa.com/produtos',
    method: 'POST',
    data: $novoProduto
);

if ($resultado['status'] === 201) {
    echo "Produto criado com ID: " . $resultado['json']['id'];
}
```

### 3. NTLM com Credenciais Personalizadas

```php
// Sobrescrever credenciais do .env
$resultado = Operacao::requisicaoComNTLM(
    url: 'https://api.interna.empresa.com/relatorio',
    method: 'GET',
    data: [],
    usuario: 'OUTRO_DOMINIO\\admin',
    senha: 'senha_admin_123'
);
```

### 4. Proxy - GET Simples

```php
// Usa configura√ß√µes do .env (PROXY_URL, PROXY_USER, PROXY_PASS)
$resultado = Operacao::requisicaoComProxy(
    url: 'https://api.externa.com/dados'
);

if ($resultado['status'] === 200) {
    $dados = $resultado['json'];
    dd($dados);
}
```

### 5. Proxy - POST atrav√©s do Proxy

```php
$payload = [
    'cliente_id' => 12345,
    'valor' => 1500.00,
    'descricao' => 'Pagamento mensal'
];

$resultado = Operacao::requisicaoComProxy(
    url: 'https://api.pagamentos.com/transacoes',
    method: 'POST',
    data: $payload
);

if ($resultado['status'] === 201) {
    echo "Transa√ß√£o criada: " . $resultado['json']['transacao_id'];
}
```

### 6. Proxy com Configura√ß√µes Personalizadas

```php
// Usar proxy diferente do configurado no .env
$resultado = Operacao::requisicaoComProxy(
    url: 'https://api.externa.com/consulta',
    method: 'GET',
    data: [],
    proxyUrl: 'proxy2.empresa.com:3128',
    proxyUsuario: 'DOMINIO\\outro_usuario',
    proxySenha: 'outra_senha'
);
```

### 7. Proxy - PUT Atualizar Recurso

```php
$atualizacao = [
    'status' => 'ativo',
    'ultima_atualizacao' => now()->toIso8601String()
];

$resultado = Operacao::requisicaoComProxy(
    url: 'https://api.externa.com/recursos/123',
    method: 'PUT',
    data: $atualizacao
);

if ($resultado['status'] === 200) {
    echo "Recurso atualizado com sucesso!";
}
```

### 8. Proxy - DELETE Remover Recurso

```php
$resultado = Operacao::requisicaoComProxy(
    url: 'https://api.externa.com/recursos/456',
    method: 'DELETE'
);

if ($resultado['status'] === 204) {
    echo "Recurso deletado com sucesso!";
}
```

### 9. Tratamento de Erros

```php
use Exception;

try {
    $resultado = Operacao::requisicaoComProxy(
        url: 'https://api.externa.com/dados',
        method: 'GET'
    );

    switch ($resultado['status']) {
        case 200:
            // Sucesso
            $dados = $resultado['json'];
            break;

        case 401:
            // N√£o autorizado
            Log::error('Credenciais inv√°lidas', [
                'mensagem' => $resultado['json']['message'] ?? 'Erro desconhecido'
            ]);
            break;

        case 403:
            // Proibido
            Log::error('Acesso negado');
            break;

        case 500:
            // Erro no servidor
            Log::error('Erro no servidor remoto', [
                'body' => $resultado['body']
            ]);
            break;

        default:
            Log::warning('Status inesperado: ' . $resultado['status']);
    }
} catch (Exception $e) {
    Log::error('Erro na requisi√ß√£o', [
        'erro' => $e->getMessage(),
        'trace' => $e->getTraceAsString()
    ]);
}
```

### 10. Uso em Controller

```php
<?php

namespace App\Http\Controllers\API;

use App\Http\Controllers\Controller;
use App\Services\Operacao;
use Illuminate\Http\JsonResponse;

class IntegracaoController extends Controller
{
    /**
     * Consultar dados de API externa atrav√©s do proxy
     */
    public function consultarDadosExternos(): JsonResponse
    {
        try {
            $resultado = Operacao::requisicaoComProxy(
                url: 'https://api.externa.com/consulta',
                method: 'GET'
            );

            if ($resultado['status'] !== 200) {
                return response()->json([
                    'success' => false,
                    'message' => 'Erro ao consultar API externa',
                    'status' => $resultado['status']
                ], $resultado['status']);
            }

            return response()->json([
                'success' => true,
                'data' => $resultado['json']
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Erro interno',
                'error' => $e->getMessage()
            ], 500);
        }
    }

    /**
     * Sincronizar dados com API interna (NTLM)
     */
    public function sincronizarDadosInternos(): JsonResponse
    {
        try {
            $dados = [
                'ultima_sincronizacao' => now()->toIso8601String(),
                'registros' => 150
            ];

            $resultado = Operacao::requisicaoComNTLM(
                url: 'https://api.interna.empresa.com/sincronizar',
                method: 'POST',
                data: $dados
            );

            return response()->json([
                'success' => $resultado['status'] === 200,
                'data' => $resultado['json']
            ], $resultado['status']);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'error' => $e->getMessage()
            ], 500);
        }
    }
}
```

---

## üêõ Troubleshooting

### Erro: "Proxy authentication required"

**Causa**: Credenciais do proxy inv√°lidas ou n√£o configuradas.

**Solu√ß√£o**:
1. Verificar `.env`:
   ```env
   PROXY_URL=proxy.empresa.com:8080
   PROXY_USER=DOMINIO\\usuario
   PROXY_PASS=senha_correta
   ```
2. Limpar cache de configura√ß√£o:
   ```bash
   php artisan config:clear
   ```

### Erro: "Failed to connect to proxy"

**Causa**: URL do proxy incorreta ou proxy inacess√≠vel.

**Solu√ß√£o**:
1. Verificar se o proxy est√° acess√≠vel:
   ```powershell
   Test-NetConnection proxy.empresa.com -Port 8080
   ```
2. Confirmar formato do `PROXY_URL`: `host:porta`

### Erro: "SSL certificate problem"

**Causa**: Certificado SSL inv√°lido ou auto-assinado.

**Solu√ß√£o tempor√°ria (apenas desenvolvimento)**:
```php
// Desabilitar verifica√ß√£o SSL (REMOVER EM PRODU√á√ÉO!)
$resultado = Operacao::requisicaoComProxy(
    url: 'https://api.externa.com/dados',
    method: 'GET'
);

// Adicionar 'verify' => false nas op√ß√µes da fun√ß√£o
```

**Solu√ß√£o permanente**: Adicionar certificado raiz ao sistema.

### Erro: "NTLM authentication failed"

**Causa**: Credenciais NTLM inv√°lidas.

**Solu√ß√£o**:
1. Verificar formato do usu√°rio: `DOMINIO\\usuario`
2. Confirmar se a senha est√° correta
3. Testar credenciais manualmente:
   ```powershell
   # Windows
   runas /user:DOMINIO\usuario cmd
   ```

### Timeout na Requisi√ß√£o

**Causa**: Servidor lento ou rede inst√°vel.

**Solu√ß√£o**: Aumentar timeout (modificar a fun√ß√£o para aceitar timeout):
```php
// Adicionar timeout nas op√ß√µes cURL
'curl' => [
    CURLOPT_TIMEOUT => 60,        // 60 segundos
    CURLOPT_CONNECTTIMEOUT => 30, // 30 segundos
    // ... outras op√ß√µes
]
```

---

## üìä Compara√ß√£o: NTLM vs Proxy

| Caracter√≠stica | requisicaoComNTLM() | requisicaoComProxy() |
|----------------|---------------------|----------------------|
| **Usa proxy** | ‚ùå N√£o | ‚úÖ Sim |
| **NTLM no servidor** | ‚úÖ Sim | üî∂ Opcional |
| **NTLM no proxy** | ‚ùå N√£o | ‚úÖ Sim |
| **Rede corporativa** | üî∂ Depende | ‚úÖ Recomendado |
| **APIs externas** | ‚ùå N√£o | ‚úÖ Sim |
| **APIs internas** | ‚úÖ Sim | üî∂ Pode usar |

---

## üîí Boas Pr√°ticas de Seguran√ßa

### 1. Nunca Expor Credenciais no C√≥digo
```php
// ‚ùå ERRADO
$resultado = Operacao::requisicaoComProxy(
    url: 'https://api.com',
    proxyUsuario: 'DOMINIO\\usuario',
    proxySenha: 'senha123'  // Credencial exposta!
);

// ‚úÖ CORRETO
$resultado = Operacao::requisicaoComProxy(
    url: 'https://api.com'
    // Usa credenciais do .env automaticamente
);
```

### 2. Adicionar .env ao .gitignore
```gitignore
# .gitignore
.env
.env.backup
.env.production
```

### 3. Usar .env.example como Template
```env
# .env.example
PROXY_URL=seu_proxy.com:8080
PROXY_USER=DOMINIO\\seu_usuario
PROXY_PASS=sua_senha
```

### 4. Logs Seguros
```php
// ‚ùå ERRADO - Logar credenciais
Log::info('Requisi√ß√£o', ['senha' => $senha]);

// ‚úÖ CORRETO - N√£o logar dados sens√≠veis
Log::info('Requisi√ß√£o', ['url' => $url, 'method' => $method]);
```

---

## üìö Refer√™ncias

- [Laravel HTTP Client](https://laravel.com/docs/11.x/http-client)
- [cURL NTLM Authentication](https://curl.se/docs/ntlm.html)
- [cURL Proxy Options](https://curl.se/libcurl/c/CURLOPT_PROXY.html)
- [RFC 4559 - NTLM HTTP Authentication](https://tools.ietf.org/html/rfc4559)

---

**Atualizado em**: 8 de outubro de 2025  
**Vers√£o**: 1.0
